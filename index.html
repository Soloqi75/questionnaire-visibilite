<script>
    function getParamsFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        
        let params = {
            email: urlParams.get('email') || '',
            dateEvent: urlParams.get('DateEvent') || '',
            logo: urlParams.get('LogoTelecharge') || '',
            justi: urlParams.get('LogoUtilise') || '',
            tag_rs: urlParams.get('TagRS') || '',
            plan_com: urlParams.get('PlanComEnvoye') || '',
            mention: urlParams.get('MentionRegion') || '',
            places: urlParams.get('Places') || '',
            placesOffertes: urlParams.get('PlacesOffertes') || ''
        };

        console.log("URL complète :", window.location.href); // Vérifie si l'URL contient bien les paramètres
        console.log("Paramètres récupérés :", params); // Vérifie dans la console du navigateur

        return params;
    }

    function togglePlacesField() {
        var places = document.getElementById("places").value;
        var placesContainer = document.getElementById("places-container");
        var combienContainer = document.getElementById("combien-container");

        if (places === "Non") {
            placesContainer.classList.add("hidden");
            combienContainer.classList.add("hidden");
            document.getElementById("combien").value = "";
        } else {
            placesContainer.classList.remove("hidden");
            if (places === "Oui") {
                combienContainer.classList.remove("hidden");
            } else {
                combienContainer.classList.add("hidden");
                document.getElementById("combien").value = "";
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const params = getParamsFromURL();

        document.getElementById("email").value = params.email;
        document.getElementById("dateEvent").value = params.dateEvent;
        document.getElementById("logo").value = params.logo;
        document.getElementById("justi").value = params.justi;
        document.getElementById("tag_rs").value = params.tag_rs;
        document.getElementById("plan_com").value = params.plan_com;
        document.getElementById("mention").value = params.mention;
        document.getElementById("places").value = params.places;
        document.getElementById("combien").value = params.placesOffertes;

        togglePlacesField(); // Vérifie si on doit cacher la question sur les places

        document.getElementById("visibilityForm").addEventListener("submit", function (event) {
            event.preventDefault();

            let formData = {
                email: document.getElementById("email").value,
                dateEvent: document.getElementById("dateEvent").value,
                logo: document.getElementById("logo").value,
                justificatif: document.getElementById("justi").value,
                tag_rs: document.getElementById("tag_rs").value,
                plan_com: document.getElementById("plan_com").value,
                mention: document.getElementById("mention").value,
                places: document.getElementById("places").value,
                combien: document.getElementById("combien").value || ""
            };

            fetch("https://prod-123.westeurope.logic.azure.com:443/workflows/d4203fbb0c1742f0954bb32a0a787cf9/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=kPnbhDVFnej3e4PeTWlOFPDxI-kNV93jA9Kw2wbEoW0", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.ok) {
                    alert("Formulaire envoyé avec succès !");
                } else {
                    response.text().then(text => alert("Erreur lors de l'envoi : " + text));
                }
            })
            .catch(error => {
                console.error("Erreur lors de l'envoi :", error);
                alert("Erreur lors de l'envoi.");
            });
        });
    });
</script>
